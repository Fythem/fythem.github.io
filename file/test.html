<html>
<head>haha</head>
<div id="res"></div>
<body>

<script>
alert("url = "+SensorsData_iOS_JS_Bridge.sensorsdata_app_server_url());

var wk_tasks = {};
var wk_task_id = 0;
function wk_sendSyncMessage(method, params) {
        try {
            var resultjson = prompt(JSON.stringify({ method: method,params: params || {} }));
//            var resultObj = resultjson ? JSON.parse(resultjson) : {};
            return resultjson;
        }
        catch (error) {
            console.log('error native message');
        }
}

function Task(id, onSuccess, onError) {
    this.id = id;
    this.onSuccess = onSuccess;
    this.onError = onError;
}

function wk_sendAsyncMessage(method, params, onSuccess, onError) {
    console.log('wk_sendAsyncMessage');
    if (onSuccess || onError) {
        var task = new Task(wk_task_id, onSuccess, onError);
        wk_tasks[wk_task_id] = task;
        wk_task_id++;
        window.webkit.messageHandlers.bitmart.postMessage({
                                                             id: task.id,
                                                             method: method,
                                                             params: params || {}
                                                             });
    } else {
        window.webkit.messageHandlers.bitmart.postMessage({
                                                           method: method,
                                                           params: params || {}
                                                           });
    }
};

function wk_onSuccess(id, message) {
    var task = wk_tasks[id];
    task.onSuccess(message);
    delete wk_tasks[id]
}

function wk_onError(id, message) {
    var task = wk_tasks[id];
    task.onError(message);
    delete wk_tasks[id]
}

function wk_log(message) {
    wk_sendAsyncMessage('log', { log: message })
}

var wk_actions = {};

function wk_register(action, callback) {
    wk_actions[action] = callback;
}

function wk_invoke(action, id, params) {
    callback = wk_actions[action];
    if (typeof callback === 'function') {
        return callback(id, params);
    } else {
        wk_log("action" + action + "not found");
    }
}

function wk_getUserSession(callback) {
    return wk_sendAsyncMessage('getUserSession', {}, callback)
}

function wk_toLogin(callback) {
    wk_sendAsyncMessage('toLogin', {}, callback)
}

function wk_privacyState(params, callback) {
    wk_sendAsyncMessage('privacyState', params, callback)
}

function wk_browser(params) {
    wk_sendAsyncMessage('browser', params, {})
}

function wk_navigateBack(callback) {
    wk_sendAsyncMessage('navigateBack', {}, callback)
}

function wk_navigationBarStatus(params) {
    wk_sendAsyncMessage('navigationBarStatus', params, {})
}

function wk_spotLeverTestSubmit(callback) {
    wk_sendAsyncMessage('spotLeverTestSubmit', {}, callback)
}

function wk_app_invoke(method, params) {
    wk_sendAsyncMessage(method, params || {}, {})
}

//兼容老版本
window.jsBridge = {};
window.jsBridge.sendAsyncMesage = wk_sendAsyncMessage;
window.jsBridge.register = wk_register;

window.jsBridge.log = wk_log;
window.jsBridge.toLogin = wk_toLogin;
window.jsBridge.getUserSession = wk_getUserSession;
window.jsBridge.privacyState = wk_privacyState;
window.jsBridge.browser = wk_browser;
window.jsBridge.navigateBack = wk_navigateBack;
window.jsBridge.spotLeverTestSubmit = wk_spotLeverTestSubmit;
window.jsBridge.invoke = wk_app_invoke;
window.jsBridge.isIOS = true;
window.jsBridge.isAndroid = false;
window.jsBridge.version = "1.0.0";
</script>
</body>
</html>
